#!/bin/sh
BARTLBY_HOME=@prefix@
XMYSQL_HOST=@MYSQL_HOST@
XMYSQL_USER=@MYSQL_USER@
XMYSQL_PASS=@MYSQL_PASS@
XMYSQL_DB=@MYSQL_DB@

chown -R bartlby ${BARTLBY_HOME}
chmod -R a+rw ${BARTLBY_HOME}/var/
chmod a+rw ${BARTLBY_HOME}/etc/bartlby.cfg


function start_it_up {
	$BARTLBY_HOME/etc/bartlby.startup stop 2>&1 >> /dev/null
	$BARTLBY_HOME/etc/bartlby.startup remove 2>&1 >> /dev/null
	
	
	echo "--------------------------------------------------------------";
	$BARTLBY_HOME/etc/bartlby.startup start
	echo "--------------------------------------------------------------";
	echo "";
	echo "";
	
	echo "####################################################";
	echo "####################################################";
	echo "###              DONE                            ###";
	echo "###   proceed installing bartlby-php, bartlby-ui ###";
	echo "####################################################";
	echo "####################################################";
	
	
}

echo "####################################################";
echo "####################################################";
echo "###              Bartlby Setup                   ###";
echo "####################################################";
echo "####################################################";
echo " You are now asked to fill in the username and password";
echo " of the 'root' mysql user, or at least someone who";
echo " can DROP and CREATE databases";
echo "####################################################";

MY_MYSQL=$(type -P mysql|tr -d [:blank:]);
MYSQL_FOUND="true";

if [ ! -x "$MY_MYSQL" ];
then
	MYSQL_FOUND="false";
fi;


while [ "$MYSQL_FOUND" = "false" ];
do
	echo "--------------------------------------------------------------";
	echo -n "mysql is not in path please give path to 'mysql' binary:";
	read MY_MYSQL;
	echo "--------------------------------------------------------------";
	
	if [ -x $MY_MYSQL ];
	then
		MYSQL_FOUND="true";	
	else
		MYSQL_FOUND="false";
	fi;
	
	
done;

MYSQL_OK=1;

while [ $MYSQL_OK = 1 ];
do

	#ok lets start a php script :-), its easier to manipulate mysql things
	echo "--------------------------------------------------------------";
	echo -n "Give username:";
	read MYSQL_USER;
	echo "--------------------------------------------------------------";
	echo "";
	echo "";
	echo "--------------------------------------------------------------";
	echo -n "Give password:";
	read MYSQL_PASSWORD;
	echo "--------------------------------------------------------------";
	echo "";
	echo "";
	echo "--------------------------------------------------------------";
	echo -n "Give host:";
	read MYSQL_HOST;
	echo "--------------------------------------------------------------";
	echo "";
	echo "";
	echo "--------------------------------------------------------------";
	echo -n "Give database name:";
	read MYSQL_DB;
	MYSQL_DO_DROP="false";
	echo "--------------------------------------------------------------";
	echo "";
	echo "";
	echo "--------------------------------------------------------------";
	echo -n "Drop database if exists?[y/n] (Default: n):";
	read MYSQL_DROP_DB;
	if [ "x$MYSQL_DROP_DB" = "xy" ];
	then
		MYSQL_DO_DROP="true";
	fi;
	
	echo "--------------------------------------------------------------";
	echo "";
	echo "";
	
	MYSQL_COMMAND="$MY_MYSQL -u $MYSQL_USER --password=$MYSQL_PASSWORD -h $MYSQL_HOST";
cat << MYSQL_SCRIPT | $MYSQL_COMMAND; 
use test;
MYSQL_SCRIPT
MYSQL_OK=$?;
	
done;

perl -i -pe "s#mysql_host=$XMYSQL_HOST#mysql_host=$MYSQL_HOST#" $BARTLBY_HOME/etc/bartlby.cfg
perl -i -pe "s#mysql_user=$XMYSQL_USER#mysql_user=$MYSQL_USER#" $BARTLBY_HOME/etc/bartlby.cfg
perl -i -pe "s#mysql_pw=$XMYSQL_PASS#mysql_pw=$MYSQL_PASSWORD#" $BARTLBY_HOME/etc/bartlby.cfg
perl -i -pe "s#mysql_db=$XMYSQL_DB#mysql_db=$MYSQL_DB#" $BARTLBY_HOME/etc/bartlby.cfg



#drop db?
if [ "$MYSQL_DO_DROP" = "true" ];
then
cat << MYSQL|$MYSQL_COMMAND
drop database if exists $MYSQL_DB;
MYSQL
MYSQL_DO_DROP="false";
fi;

cat << MYSQL | $MYSQL_COMMAND -D $MYSQL_DB
	use test;
MYSQL

EX=$?;

#if this is ok a database exists woooops?
if [ $EX != 1 ];
then
	echo "--------------------------------------------------------------";
	echo "the database already exists, you may get in trouble during DB layout changes";
	echo "drop database (remember your data is then gone, you should have a good 'BnR' backup anywhere."
	echo -n "OK your sure to drop database and start with a clean up-to-date DB?? [y/n] (default: n)";
	MYSQL_DO_DROP="false";
	read MYSQL_DROP_DB;
	echo "--------------------------------------------------------------";
	echo "";
	echo "";
	
	if [ "x$MYSQL_DROP_DB" = "xy" ];
	then
		MYSQL_DO_DROP="true";
	else
		start_it_up;
		exit;
	fi;
fi;

if [ "$MYSQL_DO_DROP" = "true" ];
then
cat << MYSQL|$MYSQL_COMMAND
drop database if exists $MYSQL_DB;
MYSQL
fi;

cat << MYSQL|$MYSQL_COMMAND

create database $MYSQL_DB;

MYSQL


cat $BARTLBY_HOME/mysql.shema|$MYSQL_COMMAND -D $MYSQL_DB;

echo "--------------------------------------------------------------";
echo "done setting up database";
echo "--------------------------------------------------------------";
echo "";
echo "";

start_it_up;


exit 0
